{{ template "layout.html" . }}

{{ define "css" }}
{{ end}}

{{ define "content" }}
	<div class="page-header">
		<h1>First Deploy</h1>
	</div>

	<div class="row">
		<div class="col-md-9">	
			<form class="form-horizontal" onsubmit="$('#idWaitingPanel').modal({backdrop: 'static'});" action="/gui/deploy/deploy/create" method="post">

				<div class="form-group">
					<label class="col-md-3 control-label" for="imageInformationName">Image Information:</label>
					<div class="col-md-9">
						<input id="imageInformationName" class="form-control" type="text" name="imageInformationName" value="{{ .imageInformationName }}" readonly="readonly">
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="version">Version:</label>
					<div class="col-md-9">
						<select id="version" class="form-control" name="version" onchange="moduleDeployDeployCreate.hideAll();moduleDeployDeployCreate.show(this.value);">
							{{ range $imageRecordKey, $imageRecord := .imageRecordSlice}}
							<option value="{{ $imageRecord.Version }}">{{ $imageRecord.Version }} {{ $imageRecord.Description }}</option>
							{{end}}
						</select>
					</div>
				</div>
				
				<div class="form-group">
					<label class="col-md-3 control-label" for="description">Description:</label>
					<div class="col-md-9">
						<input id="description" class="form-control" type="text" name="description">
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="replicaAmount">Replica Amount:</label>
					<div class="col-md-9">
						<input id="replicaAmount" class="form-control" type="number" name="replicaAmount" value="1" min="1" max="10">
					</div>
				</div>

				<div class="form-group">
					<label class="col-md-3 control-label" for="containerPort1">Container Port List:</label>
					<div class="col-md-9">
						<div id="field" class="form-inline">
							<div id="region1" >
								<input id="containerPort1" class="form-control" type="number" name="containerPort1" value="" min="1" max="65535" style="width: 100px;" required>
								<label class="control-label">Use Node Port</label>
								<input id="useNodePort1" class="col-md-offset-1 checkbox" type="checkbox" name="useNodePort1">
								<label id="labelAutoGeneratedNodePort1" class="control-label" style="display: none;">Auto Generated</label>
								<input id="autoGeneratedNodePort1" class="col-md-offset-1 checkbox" type="checkbox" name="autoGeneratedNodePort1" style="display: none;">
								<label id="labelNodePort1" class="control-label" style="display: none;">Node Port</label>
								<input id="nodePort1" class="form-control" type="number" name="nodePort1" value="" min="30000" max="32767" style="width: 100px; display: none;">
								<button id="addButton" class="btn btn-success" type="button">+</button>
							</div>
						</div>
					</div>
				</div>

				<hr>

				<div class="form-group">
					<label class="col-md-3 control-label" >Location Affinity:</label>
				</div>

				<div class="form-group">
					<label class="col-md-3 control-label" for="region">Region:</label>
					<div class="col-md-9">
						<select id="region" class="form-control" name="region" onchange="$('.cssSelectionZone').hide();$('.cssSelectionZone' + this.value).show();if(this.value=='Any'){$('#formGroupZone').hide();}else{$('#formGroupZone').show();}$('#zone').val('Any');">
							<option value="Any">Any</option>
							{{ range $regionKey, $region := .regionSlice}}
							<option value="{{ $region.Name }}">{{ $region.Name }}</option>
							{{end}}
						</select>
					</div>
				</div>

				<div id="formGroupZone" class="form-group" hidden>
					<label class="col-md-3 control-label" for="zone">Zone:</label>
					<div class="col-md-9">
						<select id="zone" class="form-control" name="zone">
							<option value="Any">Any</option>
							{{ range $regionKey, $region := .regionSlice}}
								{{ range $zoneKey, $zone := $region.ZoneSlice}}
								<option class="cssSelectionZone cssSelectionZone{{ $region.Name }}" value="{{ $zone.Name }}">{{ $zone.Name }}</option>
								{{end}}
							{{end}}
						</select>
					</div>
				</div>

				<hr>

				<div class="form-group">
					<label class="col-md-3 control-label" >Resource Reservation:</label>
				</div>

				<div class="form-group">
					<label class="col-md-3 control-label" for="resourceCPURequest">CPU Requst(CPU core):</label>
					<div class="col-md-9">
						<input id="resourceCPURequest" class="form-control" type="number" name="resourceCPURequest" min="0.1" max="16" step="0.01">
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="resourceCPULimit">CPU Limit(CPU core):</label>
					<div class="col-md-9">
						<input id="resourceCPULimit" class="form-control" type="number" name="resourceCPULimit" min="0.1" max="16" step="0.01">
					</div>
				</div>

				<div class="form-group">
					<label class="col-md-3 control-label" for="resourceMemoryRequest">Memory Requst(MB):</label>
					<div class="col-md-9">
						<input id="resourceMemoryRequest" class="form-control" type="number" name="resourceMemoryRequest" min="10" max="32768">
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="resourceMemoryLimit">Memory Limit(MB):</label>
					<div class="col-md-9">
						<input id="resourceMemoryLimit" class="form-control" type="number" name="resourceMemoryLimit" min="10" max="32768">
					</div>
				</div>

				<hr>

				<div class="form-group">
					<label class="col-md-3 control-label" >Environment Value:</label>
				</div>
				
				{{ range $imageRecordKey, $imageRecord := .imageRecordSlice}}
				<div id="{{ $imageRecord.Version }}_specific">
					{{ range $environment, $description := $imageRecord.Environment}}
					<div class="form-group">
						<label class="col-md-3 control-label" for="{{ $imageRecord.Version }}_{{ $environment }}">{{ $environment }}:</label>
						<div class="col-md-9">
							<input id="{{ $imageRecord.Version }}_{{ $environment }}" class="form-control" type="text" name="{{ $imageRecord.Version }}_{{ $environment }}" value="{{ $description }}">
						</div>
					</div>
					{{end}}
				</div>
				{{end}}

				<a class="btn btn-md btn-warning pull-right" onclick="$('#idWaitingPanel').modal({backdrop: 'static'});" href="/gui/repository/imageinformation/list">Cancel</a>
				<input class="btn btn-md btn-success pull-right" type="submit" value="Deploy">
			</form>
		</div>
	</div>
{{ end }}

{{ define "js" }}
	<script type="text/javascript">

	var moduleDeployDeployCreate = (function(){
		
		var hideAll = function() {
			{{ range $imageRecordKey, $imageRecord := .imageRecordSlice}}
			$("#{{ $imageRecord.Version }}_specific").hide()
			{{end}}
		}
		
		var show = function(version) {
			$("#" + version + "_specific").show()
		}
		
		hideAll();
		show($("#version").val());
		
		// Add dynamically input
		var next = 1;
		var hasNodePort = false;
		var indexMap = {
			"1": 1,
		}

		var functionOnClickUseNodePort = function(e){
			// Due to the Kubernetes Rest API, if one port uses node port, all ports need to use
			hasNodePort = $(this).prop("checked");

			for (var key in indexMap) {
				$("#useNodePort" + key).prop("checked", hasNodePort);

				if ($("#useNodePort" + key).prop("checked")) {
					$("#labelAutoGeneratedNodePort" + key).show();
					$("#autoGeneratedNodePort" + key).show();
					if ($("#autoGeneratedNodePort" + key).prop("checked")) {
						$("#labelNodePort" + key).hide();
						$("#nodePort" + key).hide();
						$("#nodePort" + key).prop("required", false);
					} else {
						$("#labelNodePort" + key).show();
						$("#nodePort" + key).show();
						$("#nodePort" + key).prop("required", true);
					}
				} else {
					$("#labelAutoGeneratedNodePort" + key).hide();
					$("#autoGeneratedNodePort" + key).hide();
					$("#labelNodePort" + key).hide();
					$("#nodePort" + key).hide();
					$("#nodePort" + key).prop("required", false);
				}
			}
		};

		var functionOnClickAutoGeneratedNodePort = function(e){
			var index = this.id.substring("autoGeneratedNodePort".length);
			if ($(this).prop("checked")) {
				$("#labelNodePort" + index).hide();
				$("#nodePort" + index).hide();
				$("#nodePort" + index).prop("required", false);
			} else {
				$("#labelNodePort" + index).show();
				$("#nodePort" + index).show();
				$("#nodePort" + index).prop("required", true);
			}
		};

		$("#useNodePort1").click(functionOnClickUseNodePort);
		$("#autoGeneratedNodePort1").click(functionOnClickAutoGeneratedNodePort);

		$("#addButton").click(function(e){
			e.preventDefault();
			var previousInputNodePort = "#nodePort"+next;
			var previousRegion = "#region"+next;
			next = next + 1;

			var newInputContainerPort = '<input id="containerPort' + next + '" class="form-control" type="number" name="containerPort' + next + '" value="" min="1" max="65535" style="width: 100px;" required>';
			var newLabelUseNodePort = '<label class="control-label">Use Node Port</label>';
			var newInputUseNodePort = '<input id="useNodePort' + next + '" class="col-md-offset-1 checkbox" type="checkbox" name="useNodePort' + next + '">';
			var newLabelAutoGeneratedNodePort = '<label id="labelAutoGeneratedNodePort' + next + '" class="control-label" style="display: none;">Auto generated</label>';
			var newInputAutoGeneratedNodePort = '<input id="autoGeneratedNodePort' + next + '" class="col-md-offset-1 checkbox" type="checkbox" name="autoGeneratedNodePort' + next + '" style="display: none;">';
			var newLabelNodePort = '<label id="labelNodePort' + next + '" class="control-label" style="display: none;">Node Port</label>'
			var newInputNodePort = '<input id="nodePort' + next + '" class="form-control" type="number" name="nodePort' + next + '" value="" min="30000" max="32767" style="width: 100px; display: none;">';

			var newRemoveButton = '<button id="removeButton' + (next -1) + '" class="btn btn-danger remove-me" >-</button>';

			var newRegion = '<div id="region' + next+ '">' + 
				newInputContainerPort + '\n' +
				newLabelUseNodePort + '\n' +
				newInputUseNodePort + '\n' +
				newLabelAutoGeneratedNodePort + '\n' +
				newInputAutoGeneratedNodePort + '\n' +
				newLabelNodePort + '\n' +
				newInputNodePort + '\n' +
				'</div>';

			$(previousRegion).after($(newRegion));
			$(previousInputNodePort).after($(newRemoveButton));

			indexMap[next.toString()]=next;

			$("#nodePort" + next).after($("#addButton"));

			if (hasNodePort) {
				$("#useNodePort" + next).prop("checked", hasNodePort);
				$("#labelAutoGeneratedNodePort" + next).show();
				$("#autoGeneratedNodePort" + next).show();
				$("#labelNodePort" + next).show();
				$("#nodePort" + next).show();
				$("#nodePort" + next).prop("required", true);
			}

			$("#useNodePort" + next).click(functionOnClickUseNodePort);
			$("#autoGeneratedNodePort" + next).click(functionOnClickAutoGeneratedNodePort);
			$("#removeButton" + (next-1)).click(function(e){
				e.preventDefault();
				var index = this.id.substring("removeButton".length);
				$("#region"+index).remove();
				delete indexMap[index]
			});
		});

		return {
			hideAll: hideAll,
			show: show,
		};
	})();

	</script>
{{ end}}